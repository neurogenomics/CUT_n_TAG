genes <- ChIPseeker::seq2gene(gr.dat,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
return(genes)
}) %>% `names<-`(peaks_list)
genes.seq2gene <- lapply(names(peaks_list), function(x){
print(x)
gr.dat <- peaks_list[[x]]
suppressWarnings(GenomeInfoDb::seqlevelsStyle(gr.dat) <- "UCSC")
genes <- ChIPseeker::seq2gene(gr.dat,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
return(genes)
}) %>% `names<-`(names(peaks_list))
enrich_ReactomePA <- function(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
show_plot=T){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
res <- lapply(names(annotatePeak_list), function(x){
print(x)
peakAnnot <- annotatePeak_list[[x]]
# Construct gene list
genes1 <- as.data.frame(peakAnnot)$geneId
names(genes1) = sub("_", "\n", names(genes1))
# Enrich pathway
pathway1 <- ReactomePA::enrichPathway(genes1)
dotplot1 <- ReactomePA::dotplot(pathway1,
title=paste(x,":\nReactomePA pathway enrichment"))
if(show_plot) print(dotplot1)
# Enrich pathway after seq2gene
genes2 <- ChIPseeker::seq2gene(peakAnnot@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
# Enrich pathway
pathway2 <- ReactomePA::enrichPathway(genes2,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
dotplot2 <- ReactomePA::dotplot(pathway2,
title=paste(x,":\nseq2gene + ReactomePA pathway enrichment"))
if(show_plot) print(dotplot2)
return(list(pathways=pathway1,
pathways_seq2gene=pathway2,
dotplot=dotplot1,
dotplot_seq2gene=dotplot2 ) )
}) %>% `names<-`(names(annotatePeak_list))
return(res)
}
names(genes.seq2gene)
peakAnnot
# root.dir <- "/rds/general/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
# root.dir <- "/Volumes/RDS/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
root.dir <- "/Volumes/bms20/projects/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
source("functions.R")
try({setwd(root.dir)})
knitr::opts_chunk$set(echo = T, root.dir = root.dir)
knitr::opts_knit$set(root.dir = root.dir)
library(dplyr)
# library(echolocatoR) # devtools::install_github("RajLabMSSM/echolocatoR")
library(rtracklayer) # BiocManager::install("rtracklayer")
library(ggbio) # BiocManager::install("ggbio")
library(rGADEM) # BiocManager::install("rGADEM")
library(BSgenome.Hsapiens.UCSC.hg19) #BiocManager::install("BSgenome.Hsapiens.UCSC.hg19")
library(ChIPseeker) #BiocManager::install("ChIPseeker")
library(ggupset) # install.packages("ggupset")
library(ggimage) # install.packages("ggimage")
library(clusterProfiler)
library(ReactomePA)  # BiocManager::install("ReactomePA")
library(rGADEM)
library(BSgenome.Hsapiens.UCSC.hg19)
library(GenomicRanges)
# IMPORTANT! Otherwise can have issues with rtracklayer::import()
# base::closeAllConnections()
ENCODE.broadPeaks <- rtracklayer::import("http://hgdownload.soe.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeBroadHistone/wgEncodeBroadHistoneK562H3k27acStdPk.broadPeak.gz")
CT.dir <- file.path(root.dir,"processed_data/HK5M2BBXY_merged")
CT.peaks_dir <- file.path(CT.dir,"bwa/mergedLibrary/macs/narrowPeak")
CT.bwa_dir <- file.path(CT.dir,"bwa/mergedLibrary/bigwig")
CT.bigwig_dir <- file.path(CT.dir,"bwa/mergedLibrary/bigwig")
CT.summits <- rtracklayer::import(file.path(CT.peaks_dir,
"control_R1.mLb.clN_summits.bed"))
CT.summits$width <- GenomicRanges::width(CT.summits)
summary(CT.summits$width)
# Narrow peaks
CT.annotatePeaks <-  data.table::fread(file.path(CT.peaks_dir,"control_R1.mLb.clN_peaks.annotatePeaks.txt")) %>%
dplyr::mutate(peak_score=`Peak Score`) %>%
GenomicRanges::makeGRangesFromDataFrame(seqnames.field = "Chr",
start.field = "Start", end.field = "End",strand.field = "Strand",
keep.extra.columns = T)
CT.annotatePeaks$width <- GenomicRanges::width(CT.annotatePeaks)
summary(CT.annotatePeaks$width)
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.narrowPeaks$width <- GenomicRanges::width(CT.narrowPeaks)
summary(CT.narrowPeaks$width)
ChIPseeker::covplot(peak = CT.narrowPeaks,
weightCol = "score",#"qValue",
title = "CUT&TAG peaks")
suppressWarnings(GenomeInfoDb::seqlevelsStyle(CT.narrowPeaks) <- "UCSC")
peaks_list <- list(CT=CT.narrowPeaks,
ENCODE=ENCODE.broadPeaks)
tagMatrix_list <- prepare_tagMatrix(peaks_list=peaks_list)
tagMatrix_list <- prepare_tagMatrix(peaks_list=peaks_list)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
names(peaks_list)
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
prepare_annotatePeak <- function(peaks_list,
nThread=parallel::detectCores()-1){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
parallel::mclapply(names(peaks_list), function(x){
message_parallel(x)
gr <- peaks_list[[x]]
suppressWarnings(GenomeInfoDb::seqlevelsStyle(gr) <- "UCSC")
peakAnno <- ChIPseeker::annotatePeak(peak = gr,
tssRegion=c(-3000, 3000),
TxDb=TxDb,
annoDb="org.Hs.eg.db")
return(peakAnno)
}, mc.cores = nThread) %>% `names<-`(names(peaks_list))
}
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
compare_peak_overlap(gr.query = CT.narrowPeaks,
gr.subject = ENCODE.broadPeaks)
annotatePeak_list[[1]]@anno
gene_vennplot <- function(annotatePeak_list,
use_seq2gene=F,
show_plot=T){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]$geneId }
return(genes)
}) %>% `names<-`(names(peaks_list))
# Plot
vp <- vennplot(gene_lists)
if(show_plot)print(vp)
# Return
return(list(gene_lists=gene_lists,
vennplot=vp))
}
annotatePeak_list[[x]]$geneId
annotatePeak_list[[1]]$geneId
gene_vennplot <- function(annotatePeak_list,
use_seq2gene=F,
show_plot=T){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]anno$geneId }
gene_vennplot <- function(annotatePeak_list,
use_seq2gene=F,
show_plot=T){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]anno$geneId }
gene_vennplot <- function(annotatePeak_list,
use_seq2gene=F,
show_plot=T){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(peaks_list))
# Plot
vp <- vennplot(gene_lists)
if(show_plot)print(vp)
# Return
return(list(gene_lists=gene_lists,
vennplot=vp))
}
vp_res <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = F)
vp_res.seq2gene <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = T)
vp_res <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = F)
?vennplot
# root.dir <- "/rds/general/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
# root.dir <- "/Volumes/RDS/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
root.dir <- "/Volumes/bms20/projects/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
source("functions.R")
try({setwd(root.dir)})
knitr::opts_chunk$set(echo = T, root.dir = root.dir)
knitr::opts_knit$set(root.dir = root.dir)
library(dplyr)
# library(echolocatoR) # devtools::install_github("RajLabMSSM/echolocatoR")
library(rtracklayer) # BiocManager::install("rtracklayer")
library(ggbio) # BiocManager::install("ggbio")
library(rGADEM) # BiocManager::install("rGADEM")
library(BSgenome.Hsapiens.UCSC.hg19) #BiocManager::install("BSgenome.Hsapiens.UCSC.hg19")
library(ChIPseeker) #BiocManager::install("ChIPseeker")
library(ggupset) # install.packages("ggupset")
library(ggimage) # install.packages("ggimage")
library(clusterProfiler)
library(ReactomePA)  # BiocManager::install("ReactomePA")
library(rGADEM)
library(BSgenome.Hsapiens.UCSC.hg19)
library(GenomicRanges)
# IMPORTANT! Otherwise can have issues with rtracklayer::import()
# base::closeAllConnections()
ENCODE.broadPeaks <- rtracklayer::import("http://hgdownload.soe.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeBroadHistone/wgEncodeBroadHistoneK562H3k27acStdPk.broadPeak.gz")
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.dir <- file.path(root.dir,"processed_data/HK5M2BBXY_merged")
CT.peaks_dir <- file.path(CT.dir,"bwa/mergedLibrary/macs/narrowPeak")
CT.bw_dir <- file.path(CT.dir,"bwa/mergedLibrary/bigwig")
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.narrowPeaks$width <- GenomicRanges::width(CT.narrowPeaks)
summary(CT.narrowPeaks$width)
CT.narrowPeaks$width <- GenomicRanges::width(CT.narrowPeaks)
suppressWarnings(GenomeInfoDb::seqlevelsStyle(CT.narrowPeaks) <- "UCSC")
peaks_list <- list(CT=CT.narrowPeaks,
ENCODE=ENCODE.broadPeaks)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
use_seq2gene=F
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene=use_seq2gene)
gene_lists
# Plot
vp <- ChIPseeker::vennplot(gene_lists)
# Plot
vp <- ChIPseeker::vennplot(gene_lists)
x=names(annotatePeak_list)[[1]]
peakAnnot <- annotatePeak_list[[x]]
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)[[1]]
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
peakAnnot
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
.use_seq2gene
.use_seq2gene=T
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
class(peakAnnot)
# Construct gene list
setNames(peakAnnot, x)
# Construct gene list
setNames(list(peakAnnot), x)
genes <- extract_gene_lists(setNames(list(peakAnnot), x),
use_seq2gene = .use_seq2gene)#[[1]]
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
# Construct gene list
genes <- extract_gene_lists(setNames(list(peakAnnot), x),
use_seq2gene = .use_seq2gene)#[[1]]
# Construct gene list
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)#[[1]]
genes
length(genes)
# Construct gene list
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)[[1]]
genes
length(genes)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
# Enrich pathway
pathways <- ReactomePA::enrichPathway(genes)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
.plot
enrich_ReactomePA <- function(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
res <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene,
.pvalueCutoff=pvalueCutoff,
.pAdjustMethod=pAdjustMethod){
print(x)
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)[[1]]
pathways <- ReactomePA::enrichPathway(genes,
pvalueCutoff=.pvalueCutoff,
pAdjustMethod=.pAdjustMethod)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
if(show_plot) print(.plot)
return(list(pathways=pathways,
dotplot=.plot) )
}) %>% `names<-`(names(annotatePeak_list))
return(res)
}
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
gene_lists
fun="enrichKEGG"
pvalueCutoff  = 0.05
pAdjustMethod = "BH"
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(gsub("^enrich","",fun),"pathway enrichment"))
.plot
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
.plot
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T)
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T,
show_plot = T)
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T,
show_plot = T)
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = F,
show_plot = T)
res_ReactomePA <- enrich_ReactomePA(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = F)
pathways <- ReactomePA::enrichPathway(gene_lists,
pvalueCutoff=.pvalueCutoff,
pAdjustMethod=.pAdjustMethod)
pathways
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
res_ReactomePA <- enrich_ReactomePA(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T)
peaks_list <- list("CUT&TAG"=CT.narrowPeaks,
"ENCODE"=ENCODE.broadPeaks)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
