# Return
return(list(gene_lists=gene_lists,
vennplot=vp))
}
vp_res <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = F)
vp_res.seq2gene <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = T)
vp_res <- gene_vennplot(annotatePeak_list = annotatePeak_list,
use_seq2gene = F)
?vennplot
# root.dir <- "/rds/general/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
# root.dir <- "/Volumes/RDS/project/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
root.dir <- "/Volumes/bms20/projects/neurogenomics-lab/live/GitRepos/CUT_n_TAG"
source("functions.R")
try({setwd(root.dir)})
knitr::opts_chunk$set(echo = T, root.dir = root.dir)
knitr::opts_knit$set(root.dir = root.dir)
library(dplyr)
# library(echolocatoR) # devtools::install_github("RajLabMSSM/echolocatoR")
library(rtracklayer) # BiocManager::install("rtracklayer")
library(ggbio) # BiocManager::install("ggbio")
library(rGADEM) # BiocManager::install("rGADEM")
library(BSgenome.Hsapiens.UCSC.hg19) #BiocManager::install("BSgenome.Hsapiens.UCSC.hg19")
library(ChIPseeker) #BiocManager::install("ChIPseeker")
library(ggupset) # install.packages("ggupset")
library(ggimage) # install.packages("ggimage")
library(clusterProfiler)
library(ReactomePA)  # BiocManager::install("ReactomePA")
library(rGADEM)
library(BSgenome.Hsapiens.UCSC.hg19)
library(GenomicRanges)
# IMPORTANT! Otherwise can have issues with rtracklayer::import()
# base::closeAllConnections()
ENCODE.broadPeaks <- rtracklayer::import("http://hgdownload.soe.ucsc.edu/goldenPath/hg19/encodeDCC/wgEncodeBroadHistone/wgEncodeBroadHistoneK562H3k27acStdPk.broadPeak.gz")
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.dir <- file.path(root.dir,"processed_data/HK5M2BBXY_merged")
CT.peaks_dir <- file.path(CT.dir,"bwa/mergedLibrary/macs/narrowPeak")
CT.bw_dir <- file.path(CT.dir,"bwa/mergedLibrary/bigwig")
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.narrowPeaks <- rtracklayer::import.bed(file.path(CT.peaks_dir,
"control_R1.mLb.clN_peaks.narrowPeak"))
CT.narrowPeaks$width <- GenomicRanges::width(CT.narrowPeaks)
summary(CT.narrowPeaks$width)
CT.narrowPeaks$width <- GenomicRanges::width(CT.narrowPeaks)
suppressWarnings(GenomeInfoDb::seqlevelsStyle(CT.narrowPeaks) <- "UCSC")
peaks_list <- list(CT=CT.narrowPeaks,
ENCODE=ENCODE.broadPeaks)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
use_seq2gene=F
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene=use_seq2gene)
gene_lists
# Plot
vp <- ChIPseeker::vennplot(gene_lists)
# Plot
vp <- ChIPseeker::vennplot(gene_lists)
x=names(annotatePeak_list)[[1]]
peakAnnot <- annotatePeak_list[[x]]
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)[[1]]
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
peakAnnot
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
.use_seq2gene
.use_seq2gene=T
# Construct gene list
genes <- extract_gene_lists(peakAnnot,
use_seq2gene = .use_seq2gene)#[[1]]
genes
class(peakAnnot)
# Construct gene list
setNames(peakAnnot, x)
# Construct gene list
setNames(list(peakAnnot), x)
genes <- extract_gene_lists(setNames(list(peakAnnot), x),
use_seq2gene = .use_seq2gene)#[[1]]
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
# Construct gene list
genes <- extract_gene_lists(setNames(list(peakAnnot), x),
use_seq2gene = .use_seq2gene)#[[1]]
# Construct gene list
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)#[[1]]
genes
length(genes)
# Construct gene list
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)[[1]]
genes
length(genes)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
# Enrich pathway
pathways <- ReactomePA::enrichPathway(genes)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
.plot
enrich_ReactomePA <- function(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
res <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene,
.pvalueCutoff=pvalueCutoff,
.pAdjustMethod=pAdjustMethod){
print(x)
genes <- extract_gene_lists(annotatePeak_list[x],
use_seq2gene = .use_seq2gene)[[1]]
pathways <- ReactomePA::enrichPathway(genes,
pvalueCutoff=.pvalueCutoff,
pAdjustMethod=.pAdjustMethod)
.plot <- ReactomePA::dotplot(pathways,
title=paste(x,":\n",
if(.use_seq2gene)"seq2gene +",
"ReactomePA pathway enrichment"))
if(show_plot) print(.plot)
return(list(pathways=pathways,
dotplot=.plot) )
}) %>% `names<-`(names(annotatePeak_list))
return(res)
}
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
gene_lists
fun="enrichKEGG"
pvalueCutoff  = 0.05
pAdjustMethod = "BH"
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(gsub("^enrich","",fun),"pathway enrichment"))
.plot
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
.plot
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T)
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(x,"\n",
if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T,
show_plot = T)
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
print(x)
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
enrich_clusterProfiler <- function(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene=F,
show_plot=T){
gene_lists <- extract_gene_lists(annotatePeak_list,
use_seq2gene = use_seq2gene)
pathways <- clusterProfiler::compareCluster(geneCluster   = gene_lists,
fun = fun,
pvalueCutoff  = pvalueCutoff,
pAdjustMethod = pAdjustMethod)
.plot <- clusterProfiler::dotplot(pathways,
showCategory = 15,
title = paste(if(use_seq2gene)"seq2gene +",
gsub("^enrich","",fun),"pathway enrichment"))
if(show_plot)print(.plot)
return(list(pathways=pathways,
dotplot=.plot ) )
}
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T,
show_plot = T)
res_clusterProfiler <- enrich_clusterProfiler(annotatePeak_list,
fun="enrichKEGG",
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = F,
show_plot = T)
res_ReactomePA <- enrich_ReactomePA(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = F)
pathways <- ReactomePA::enrichPathway(gene_lists,
pvalueCutoff=.pvalueCutoff,
pAdjustMethod=.pAdjustMethod)
pathways
extract_gene_lists <- function(annotatePeak_list,
use_seq2gene=F){
TxDb <- TxDb.Hsapiens.UCSC.hg19.knownGene::TxDb.Hsapiens.UCSC.hg19.knownGene
gene_lists <- lapply(names(annotatePeak_list), function(x,
.use_seq2gene=use_seq2gene){
if(.use_seq2gene){
genes <- ChIPseeker::seq2gene(annotatePeak_list[[x]]@anno,
tssRegion = c(-1000, 1000),
flankDistance = 3000,
TxDb=TxDb)
} else{ genes <- annotatePeak_list[[x]]@anno$geneId }
return(genes)
}) %>% `names<-`(names(annotatePeak_list))
return(gene_lists)
}
res_ReactomePA <- enrich_ReactomePA(annotatePeak_list,
pvalueCutoff  = 0.05,
pAdjustMethod = "BH",
use_seq2gene = T)
peaks_list <- list("CUT&TAG"=CT.narrowPeaks,
"ENCODE"=ENCODE.broadPeaks)
annotatePeak_list <- prepare_annotatePeak(peaks_list = peaks_list)
library(PeakyFinders)
library(EpiCompare)
# saveRDS(consensus_peaks_ct,"consensus_peaks.GSE199611.rds")
consensus_peaks_ct <- readRDS("consensus_peaks.GSE199611.rds")
peaks_tip <- readRDS("~/Downloads/peaks_tip_hg38.rds")
names(peaks_tip) <- paste("TIP-seq",names(peaks_tip),sep=".")
peaks_tip
peaks_grouped
peaks_grouped_tip <- EpiCompare::group_files(peakfiles = peaks_tip,
peaks_grouped_tip
peaks_grouped_tip
peaks_grouped_tip
searches = list(assay=c("H3k27me3","H3K27ac"))
peaks_grouped_tip <- EpiCompare::group_files(
peakfiles = peaks_tip,
searches = list(assay=c("H3k27me3","H3K27ac"))
)
list(assay=c("H3k27me3","H3K27ac")
list(assay=c("H3k27me3","H3K27ac"))
library(PeakyFinders)
library(EpiCompare)
peaks_tip <- readRDS("~/Downloads/peaks_tip_hg38.rds")
names(peaks_tip) <- paste("TIP-seq",names(peaks_tip),sep=".")
peaks_grouped_tip <- EpiCompare::group_files(
peakfiles = peaks_tip,
searches = list(assay=c("H3k27me3","H3K27ac"))
)
peaks_grouped_tip
peaks_grouped_tip[names(peaks_tip)]
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
peaks_grouped_tip <- EpiCompare::group_files(
peakfiles = peaks_tip,
searches = list(assay=c("TIP-seq"),
histone=c("H3k27me3","H3K27ac"))
)
peaks_grouped_tip
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
peaks_tip <- readRDS("~/Downloads/peaks_tip_hg38.rds")
names(peaks_tip) <- paste("TIP-seq",names(peaks_tip),sep=".")
peaks_grouped_tip <- EpiCompare::group_files(
peakfiles = peaks_tip,
searches = list(assay=c("TIP-seq"),
histone=c("H3k27me3","H3K27ac"))
)
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
closeAllConnections()
closeAllConnections()
closeAllConnections()
closeAllConnections()
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
library(PeakyFinders)
library(EpiCompare)
peaks_tip <- readRDS("~/Downloads/peaks_tip_hg38.rds")
names(peaks_tip) <- paste("TIP-seq",names(peaks_tip),sep=".")
peaks_grouped_tip <- EpiCompare::group_files(
peakfiles = peaks_tip,
searches = list(assay=c("TIP-seq"),
histone=c("H3k27me3","H3K27ac"))
)
peaks_grouped_tip
peaks_grouped_tip[names(peaks_tip)]
consensus_peaks_tip <- EpiCompare::compute_consensus_peaks(
grlist = peaks_tip,
groups = peaks_grouped_tip[names(peaks_tip)],
genome_build = "hg38",
method = "consensusseeker",
nbrThreads = 10)
saveRDS(consensus_peaks_tip,"consensus_peaks_tip.rds")
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
# saveRDS(consensus_peaks_ct,"consensus_peaks.GSE199611.rds")
consensus_peaks_ct <- readRDS("consensus_peaks.GSE199611.rds")
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
length(v)
length(peakfiles_all)
peakfiles_all
names(consensus_peaks_ct) <- paste0("CUT&Tag",names(consensus_peaks_ct),sep="_")
consensus_peaks_ct
# saveRDS(consensus_peaks_ct,"consensus_peaks.GSE199611.rds")
consensus_peaks_ct <- readRDS("consensus_peaks.GSE199611.rds")
names(consensus_peaks_ct) <- paste("CUT&Tag",names(consensus_peaks_ct),sep="_")
names(consensus_peaks_ct)
saveRDS(consensus_peaks_ct,"consensus_peaks.GSE199611.rds")
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
names(peakfiles_all)
consensus_peaks_ct <- EpiCompare::liftover_grlist(grlist = consensus_peaks_ct,
input_build = "hg19",
output_build = "hg38")
consensus_peaks_ct
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
data("hg38_blacklist")
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
res <- EpiCompare::EpiCompare(peakfiles = peakfiles_all,
genome_build = list(peakfiles="hg38",
reference="hg38",
blacklist="hg38"),
blacklist = hg38_blacklist,
genome_build_output = "hg38",
reference = list(ENCODE_H3K27ac_ENCFF038DDS=reference$ENCODE$ENCFF038DDS,
ENCODE_H3K27me3_ENCFF049HUP=reference$ENCODE$ENCFF049HUP),
chromHMM_plot = TRUE,
chromHMM_annotation = "K562",
chipseeker_plot = TRUE,
enrichment_plot = TRUE,
tss_plot = TRUE,
stat_plot = TRUE,
upset_plot = TRUE,
precision_recall_plot = TRUE,
corr_plot = TRUE,
interact = TRUE,
save_output = TRUE,
output_dir = here::here("EpiCompare_CnT_CnR_TIP_consensus"))
marks <- c("H3K122","H3K27ac","H3K64ac","H3K27me3")
meta <- PeakyFinders::search_encode(target =  c("H3K122","H3K27ac",
"H3K64ac","H3K27me3"),
biosample_name = "K562",
organism = "Homo sapiens",
assembly = "GRCh38",
file_type = "narrowPeak",
output_type=c("replicated peaks"), # "^peaks$"
peaks_only = TRUE)
meta <- meta[grepl(paste(marks,collapse = "|"), target, ignore.case = TRUE),]
reference <- PeakyFinders::import_peaks(ids = meta$file_accession,  # "ENCSR000AKP"
builds = "GRCh38")
data("hg38_blacklist")
peakfiles_all <- c(consensus_peaks_ct,consensus_peaks_tip)
res <- EpiCompare::EpiCompare(peakfiles = peakfiles_all,
genome_build = list(peakfiles="hg38",
reference="hg38",
blacklist="hg38"),
blacklist = hg38_blacklist,
genome_build_output = "hg38",
reference = list(ENCODE_H3K27ac_ENCFF038DDS=reference$ENCODE$ENCFF038DDS,
ENCODE_H3K27me3_ENCFF049HUP=reference$ENCODE$ENCFF049HUP),
chromHMM_plot = TRUE,
chromHMM_annotation = "K562",
chipseeker_plot = TRUE,
enrichment_plot = TRUE,
tss_plot = TRUE,
stat_plot = TRUE,
upset_plot = TRUE,
precision_recall_plot = TRUE,
corr_plot = TRUE,
interact = TRUE,
save_output = TRUE,
output_dir = here::here("EpiCompare_CnT_CnR_TIP_consensus"))
length(peakfiles_all)
consensus_peaks_ct
res <- EpiCompare::EpiCompare(peakfiles = peakfiles_all,
genome_build = list(peakfiles="hg38",
reference="hg38",
blacklist="hg38"),
blacklist = hg38_blacklist,
genome_build_output = "hg38",
reference = list(ENCODE_H3K27ac_ENCFF038DDS=reference$ENCODE$ENCFF038DDS,
ENCODE_H3K27me3_ENCFF049HUP=reference$ENCODE$ENCFF049HUP),
chromHMM_plot = TRUE,
chromHMM_annotation = "K562",
chipseeker_plot = TRUE,
enrichment_plot = TRUE,
tss_plot = TRUE,
stat_plot = TRUE,
upset_plot = TRUE,
# precision_recall_plot = TRUE,
# corr_plot = TRUE,
interact = TRUE,
save_output = TRUE,
output_dir = here::here("EpiCompare_CnT_CnR_TIP_consensus"))
list.files("/Users/schilder/Desktop/CUT_n_TAG/EpiCompare_CnT_CnR_TIP_consensus/EpiCompare")
list.files("/Users/schilder/Desktop/CUT_n_TAG/EpiCompare_CnT_CnR_TIP_consensus/")
